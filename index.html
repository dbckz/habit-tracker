<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave's Habit Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23e91e63'/><path d='M30 50 L45 65 L70 35' stroke='white' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf8f5;
            --bg-secondary: #f0ebe4;
            --bg-card: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-muted: #b2bec3;
            --accent-warm: #e17055;
            --accent-success: #00b894;
            --accent-fail: #d63031;
            --border: #dfe6e9;
            --shadow: rgba(45, 52, 54, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(225, 112, 85, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 184, 148, 0.05) 0%, transparent 50%);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .date-display {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            color: var(--accent-warm);
            margin-top: 1rem;
            font-weight: 600;
        }

        /* Overall metrics */
        .overall-metrics {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 4rem;
        }

        .overall-stat {
            text-align: center;
        }

        .overall-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-warm);
        }

        .overall-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .overall-stat-percent {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .stat-percent {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.1rem;
        }

        /* Status indicator */
        .status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        .status.saving {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            opacity: 1;
        }

        .status.saved {
            background: rgba(0, 184, 148, 0.1);
            color: var(--accent-success);
            opacity: 1;
        }

        .status.error {
            background: rgba(214, 48, 49, 0.1);
            color: var(--accent-fail);
            opacity: 1;
        }

        /* Add Habit Form */
        .add-habit-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border);
        }

        .add-habit-form {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .add-habit-form input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }

        .add-habit-form input:focus {
            outline: none;
            border-color: var(--accent-warm);
            box-shadow: 0 0 0 4px rgba(225, 112, 85, 0.1);
        }

        .add-habit-form input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent-warm);
            color: white;
        }

        .btn-primary:hover {
            background: #d35844;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(225, 112, 85, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Habits List */
        .habits-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .habit-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .habit-name {
            font-family: 'Fraunces', serif;
            font-size: 1.35rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .habit-created {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .habit-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            transition: color 0.2s ease;
            line-height: 1;
        }

        .habit-delete:hover {
            color: var(--accent-fail);
        }

        /* Stats */
        .habit-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-warm);
        }

        .stat-value.success {
            color: var(--accent-success);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Note Totals */
        .note-totals {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .note-total-item {
            font-weight: 500;
        }

        .note-total-divider {
            color: var(--text-muted);
        }

        /* Week View */
        .week-view {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .day-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .day-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .day-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s ease;
        }

        .day-btn:hover {
            border-color: var(--text-muted);
            transform: scale(1.05);
        }

        .day-btn.completed {
            background: var(--accent-success);
            border-color: var(--accent-success);
            color: white;
            animation: pop 0.3s ease;
        }

        .day-btn.missed {
            background: var(--accent-fail);
            border-color: var(--accent-fail);
            color: white;
            animation: pop 0.3s ease;
        }

        .day-btn.today {
            border-color: var(--accent-warm);
            box-shadow: 0 0 0 3px rgba(225, 112, 85, 0.15);
        }

        .day-btn.future {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .day-note {
            width: 48px;
            padding: 0.25rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.7rem;
            text-align: center;
            background: var(--bg-primary);
            font-family: inherit;
            color: var(--text-primary);
            margin-top: 0.25rem;
            transition: all 0.2s ease;
        }

        .day-note:focus {
            outline: none;
            border-color: var(--accent-warm);
            box-shadow: 0 0 0 2px rgba(225, 112, 85, 0.1);
        }

        .day-note::placeholder {
            color: var(--text-muted);
            font-size: 0.65rem;
        }

        .day-note:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Week Navigation */
        .week-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .week-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .week-nav-btn:hover:not(:disabled) {
            border-color: var(--accent-warm);
            color: var(--accent-warm);
        }

        .week-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .week-label {
            font-family: 'Fraunces', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            min-width: 200px;
            text-align: center;
        }

        .week-label-current {
            color: var(--accent-warm);
            font-weight: 600;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h2 {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-warm);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            color: var(--text-secondary);
        }

        .tab:hover {
            border-color: var(--text-muted);
        }

        .tab.active {
            background: var(--accent-warm);
            border-color: var(--accent-warm);
            color: white;
        }

        .tab .count {
            display: inline-block;
            background: rgba(0, 0, 0, 0.1);
            padding: 0.1rem 0.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        .tab.active .count {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-deleted {
            opacity: 0.5;
        }

        .tab-deleted:hover {
            opacity: 0.8;
        }

        .tab-deleted.active {
            opacity: 1;
        }

        /* Deleted habit card styling */
        .habit-card.deleted {
            opacity: 0.7;
            background: var(--bg-secondary);
        }

        .habit-card.deleted .day-btn {
            cursor: not-allowed;
        }

        .restore-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--accent-success);
            border-radius: 8px;
            background: transparent;
            color: var(--accent-success);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .restore-btn:hover {
            background: var(--accent-success);
            color: white;
        }

        .delete-permanent-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--accent-fail);
            border-radius: 8px;
            background: transparent;
            color: var(--accent-fail);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            margin-left: 0.5rem;
        }

        .delete-permanent-btn:hover {
            background: var(--accent-fail);
            color: white;
        }

        .deleted-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Section headers for Active tab */
        .section-header {
            font-family: 'Fraunces', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 1.5rem 0 0.75rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .section-header .section-count {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* Analytics Tab */
        .analytics-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .analytics-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border);
        }

        .analytics-card h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .habit-progress-bar {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-label {
            width: 120px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.3s ease;
        }

        .progress-value {
            width: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: right;
        }

        /* Weekly heat map */
        .weekly-heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .heatmap-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
        }

        .heatmap-day-label {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        /* Trend chart */
        .trend-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            gap: 0.25rem;
            padding: 0.5rem 0;
        }

        .trend-bar {
            flex: 1;
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
            position: relative;
        }

        .trend-bar:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 10;
        }

        .trend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .add-habit-form {
                flex-direction: column;
            }

            .add-habit-form input,
            .btn {
                width: 100%;
            }

            .habit-stats {
                gap: 1rem;
            }

            .day-btn {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }

            .day-note {
                width: 40px;
                font-size: 0.6rem;
                padding: 0.2rem;
            }

            .week-view {
                gap: 0.25rem;
            }

            .week-label {
                font-size: 0.95rem;
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="status"></div>
    
    <div class="container">
        <header>
            <h1>Dave's Habit Tracker</h1>
            <p class="subtitle">Small steps, every day</p>
            <p class="date-display" id="currentDate"></p>
        </header>

        <section class="overall-metrics" id="overallMetrics">
            <div class="overall-stat">
                <div class="overall-stat-value" id="overallWeekly">0 / 0</div>
                <div class="overall-stat-label">Past Week</div>
            </div>
            <div class="overall-stat">
                <div class="overall-stat-value" id="overallAllTime">0 / 0</div>
                <div class="overall-stat-label">All Time</div>
                <div class="overall-stat-percent" id="overallAllTimePercent">0%</div>
            </div>
        </section>

        <section class="add-habit-section">
            <form class="add-habit-form" id="addHabitForm">
                <input type="text" id="habitInput" placeholder="Enter a new habit to track..." autocomplete="off">
                <button type="submit" class="btn btn-primary">Add Habit</button>
            </form>
        </section>

        <div class="week-nav">
            <button class="week-nav-btn" onclick="changeWeek(-1)" title="Previous week">‚Üê</button>
            <span class="week-label" id="weekLabel">This week</span>
            <button class="week-nav-btn" id="nextWeekBtn" onclick="changeWeek(1)" title="Next week" disabled>‚Üí</button>
        </div>

        <div class="tabs" id="tabs">
            <button class="tab" data-tab="backlog" onclick="switchTab('backlog')">
                Backlog <span class="count" id="backlogCount">0</span>
            </button>
            <button class="tab active" data-tab="active" onclick="switchTab('active')">
                Active <span class="count" id="activeCount">0</span>
            </button>
            <button class="tab" data-tab="analytics" onclick="switchTab('analytics')">
                Analytics
            </button>
            <button class="tab tab-deleted" data-tab="deleted" onclick="switchTab('deleted')">
                Deleted <span class="count" id="deletedCount">0</span>
            </button>
        </div>

        <section class="habits-section" id="habitsList">
            <div class="loading">Loading habits</div>
        </section>
    </div>

    <script>
        // API base URL
        const API_URL = '/api/habits';

        // In-memory cache of habits
        let habitsCache = [];

        // Current tab
        let currentTab = 'active';

        // Week offset (0 = current week, -1 = last week, etc.)
        let weekOffset = 0;

        // Status indicator
        const statusEl = document.getElementById('status');
        let statusTimeout;

        function showStatus(message, type = 'saved') {
            clearTimeout(statusTimeout);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;

            if (type !== 'error') {
                statusTimeout = setTimeout(() => {
                    statusEl.className = 'status';
                }, 2000);
            }
        }

        // Get today's date as YYYY-MM-DD
        function getDateString(date = new Date()) {
            return date.toISOString().split('T')[0];
        }

        // Get day name
        function getDayName(date) {
            return date.toLocaleDateString('en-GB', { weekday: 'short' });
        }

        // Get day number
        function getDayNumber(date) {
            return date.getDate();
        }

        // Format display date
        function formatDisplayDate(date) {
            return date.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Format created date
        function formatCreatedDate(isoString) {
            if (!isoString) return '';
            return new Date(isoString).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // Get completion status (handles both old string format and new object format)
        function getCompletionStatus(completions, date) {
            const entry = (completions || {})[date];
            if (!entry) return null;
            if (typeof entry === 'string') return entry;
            return entry.status || null;
        }

        // Get completion note (handles both formats)
        function getCompletionNote(completions, date) {
            const entry = (completions || {})[date];
            if (!entry || typeof entry === 'string') return '';
            return entry.note || '';
        }

        // Set completion (preserves note if exists)
        function setCompletion(completions, date, status, note) {
            if (!status && !note) {
                delete completions[date];
            } else if (note) {
                completions[date] = { status: status || null, note };
            } else {
                completions[date] = status;
            }
        }

        // Get 7 days for a given week offset (0 = current week ending today)
        function getLast7Days(offset = 0) {
            const days = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i + (offset * 7));
                date.setHours(0, 0, 0, 0);

                const dateStr = getDateString(date);
                const todayStr = getDateString(today);

                days.push({
                    date: dateStr,
                    dayName: getDayName(date),
                    dayNumber: getDayNumber(date),
                    isToday: dateStr === todayStr,
                    isFuture: date > today
                });
            }
            return days;
        }

        // Get week label for display
        function getWeekLabel(offset) {
            if (offset === 0) return 'This week';
            if (offset === -1) return 'Last week';

            const days = getLast7Days(offset);
            const startDate = new Date(days[0].date);
            const endDate = new Date(days[6].date);

            const formatOpts = { day: 'numeric', month: 'short' };
            return `${startDate.toLocaleDateString('en-GB', formatOpts)} ‚Äì ${endDate.toLocaleDateString('en-GB', formatOpts)}`;
        }

        // Change week
        function changeWeek(delta) {
            weekOffset += delta;
            if (weekOffset > 0) weekOffset = 0; // Can't go to future weeks

            updateWeekNav();
            renderHabits();
        }

        // Update week navigation UI
        function updateWeekNav() {
            const label = document.getElementById('weekLabel');
            const nextBtn = document.getElementById('nextWeekBtn');

            label.textContent = getWeekLabel(weekOffset);
            label.classList.toggle('week-label-current', weekOffset === 0);
            nextBtn.disabled = weekOffset >= 0;
        }

        // Load habits from server
        async function loadHabits() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Failed to load');
                habitsCache = await response.json();
                return habitsCache;
            } catch (error) {
                console.error('Error loading habits:', error);
                showStatus('Failed to load habits', 'error');
                return [];
            }
        }

        // Save habits to server
        async function saveHabits(habits) {
            showStatus('Saving...', 'saving');
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(habits)
                });
                if (!response.ok) throw new Error('Failed to save');
                habitsCache = habits;
                showStatus('Saved ‚úì', 'saved');
            } catch (error) {
                console.error('Error saving habits:', error);
                showStatus('Failed to save', 'error');
            }
        }

        // Calculate streak
        function calculateStreak(completions) {
            let streak = 0;
            const today = new Date();
            let checkDate = new Date(today);

            // Check if today is completed to start the streak
            if (getCompletionStatus(completions, getDateString(today)) === 'completed') {
                streak = 1;
            }
            checkDate.setDate(checkDate.getDate() - 1);

            // Count consecutive completed days going backwards
            while (getCompletionStatus(completions, getDateString(checkDate)) === 'completed') {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            }

            return streak;
        }

        // Calculate past week stats (X / 7)
        function calculateWeeklyStats(completions) {
            const days = getLast7Days();
            const completed = days.filter(day => getCompletionStatus(completions, day.date) === 'completed').length;
            return { completed, total: 7 };
        }

        // Calculate sum of numeric notes for the past week
        function calculateWeeklyNoteTotal(completions) {
            const days = getLast7Days();
            let total = 0;
            days.forEach(day => {
                const note = getCompletionNote(completions, day.date);
                const num = parseFloat(note);
                if (!isNaN(num)) {
                    total += num;
                }
            });
            return total;
        }

        // Calculate sum of numeric notes for the current year
        function calculateYearlyNoteTotal(completions) {
            const safeCompletions = completions || {};
            const currentYear = new Date().getFullYear();
            let total = 0;

            Object.keys(safeCompletions).forEach(date => {
                if (date.startsWith(currentYear.toString())) {
                    const note = getCompletionNote(safeCompletions, date);
                    const num = parseFloat(note);
                    if (!isNaN(num)) {
                        total += num;
                    }
                }
            });
            return total;
        }

        // Check if habit has any numeric notes
        function hasNumericNotes(completions) {
            const safeCompletions = completions || {};
            return Object.keys(safeCompletions).some(date => {
                const note = getCompletionNote(safeCompletions, date);
                return note && !isNaN(parseFloat(note));
            });
        }

        // Calculate all time stats (X / Y)
        function calculateAllTimeStats(completions, createdAt) {
            const safeCompletions = completions || {};

            // Get all completion dates
            const completionDates = Object.keys(safeCompletions).filter(date =>
                getCompletionStatus(safeCompletions, date) === 'completed'
            );

            // Determine start date: use earliest of createdAt or first completion (for backdated entries)
            let startDate;
            if (completionDates.length > 0) {
                completionDates.sort();
                const earliestCompletion = new Date(completionDates[0]);
                const created = createdAt ? new Date(createdAt) : earliestCompletion;
                startDate = earliestCompletion < created ? earliestCompletion : created;
            } else if (createdAt) {
                startDate = new Date(createdAt);
            } else {
                return { completed: 0, total: 0 };
            }
            startDate.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalDays = 0;
            let completedDays = 0;
            let checkDate = new Date(startDate);

            while (checkDate <= today) {
                totalDays++;
                if (getCompletionStatus(safeCompletions, getDateString(checkDate)) === 'completed') {
                    completedDays++;
                }
                checkDate.setDate(checkDate.getDate() + 1);
            }

            return { completed: completedDays, total: totalDays };
        }

        // Thresholds for habit stages
        const CONSISTENCY_THRESHOLD = 7;  // Days for "consistency built"
        const ESTABLISHED_THRESHOLD = 21; // Days for "established"

        // Check if habit has any completions
        function hasCompletions(habit) {
            const completions = habit.completions || {};
            return Object.keys(completions).some(date => getCompletionStatus(completions, date) === 'completed');
        }

        // Check if habit is established (21+ day streak)
        function isEstablished(habit) {
            return calculateStreak(habit.completions || {}) >= ESTABLISHED_THRESHOLD;
        }

        // Check if habit has consistency built (7-20 day streak)
        function hasConsistency(habit) {
            const streak = calculateStreak(habit.completions || {});
            return streak >= CONSISTENCY_THRESHOLD && streak < ESTABLISHED_THRESHOLD;
        }

        // Check if habit is recently started (< 7 day streak)
        function isRecentlyStarted(habit) {
            const streak = calculateStreak(habit.completions || {});
            return hasCompletions(habit) && streak < CONSISTENCY_THRESHOLD;
        }

        // Get all in-progress habits (started, not deleted)
        function getInProgressHabits() {
            return habitsCache.filter(h => !h.deleted && hasCompletions(h));
        }

        // Get active habits grouped by stage
        function getActiveHabitsGrouped() {
            const inProgress = getInProgressHabits();
            return {
                recentlyStarted: inProgress.filter(h => isRecentlyStarted(h)),
                consistencyBuilt: inProgress.filter(h => hasConsistency(h)),
                established: inProgress.filter(h => isEstablished(h))
            };
        }

        // Get backlog habits (no completions yet)
        function getBacklogHabits() {
            return habitsCache.filter(h => !h.deleted && !hasCompletions(h));
        }

        // Get deleted habits
        function getDeletedHabits() {
            return habitsCache.filter(h => h.deleted);
        }

        // Calculate health score (0-1) based on recent completion rate
        // Only considers in-progress habits
        function calculateHealthScore(habit) {
            const completions = habit.completions || {};
            const days = getLast7Days();
            let completed = 0;
            let total = 0;

            days.forEach(day => {
                if (!day.isFuture) {
                    total++;
                    if (getCompletionStatus(completions, day.date) === 'completed') {
                        completed++;
                    }
                }
            });

            return total > 0 ? completed / total : 0;
        }

        // Calculate overall health score for all in-progress habits
        function calculateOverallHealthScore() {
            const habits = getInProgressHabits();
            if (habits.length === 0) return 0.5; // Neutral if no habits

            let totalScore = 0;
            habits.forEach(habit => {
                totalScore += calculateHealthScore(habit);
            });

            return totalScore / habits.length;
        }

        // Convert health score to color (red to green gradient)
        function healthToColor(score) {
            // Interpolate between red (0) and green (1)
            // Red: hsl(0, 70%, 50%)
            // Yellow: hsl(45, 80%, 50%)
            // Green: hsl(160, 70%, 40%)

            let hue, saturation, lightness;

            if (score < 0.5) {
                // Red to yellow (0 to 0.5)
                const t = score * 2;
                hue = t * 45;
                saturation = 70 + t * 10;
                lightness = 50;
            } else {
                // Yellow to green (0.5 to 1)
                const t = (score - 0.5) * 2;
                hue = 45 + t * 115;
                saturation = 80 - t * 10;
                lightness = 50 - t * 10;
            }

            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        // Get color with opacity for backgrounds
        function healthToBackgroundColor(score, opacity = 0.08) {
            const h = score < 0.5 ? score * 90 : 45 + (score - 0.5) * 230;
            return `hsla(${h}, 70%, 50%, ${opacity})`;
        }

        // Update page colors based on overall health
        function updatePageColors() {
            const score = calculateOverallHealthScore();
            const bgColor = healthToBackgroundColor(score, 0.04);

            document.body.style.backgroundImage = `
                radial-gradient(circle at 20% 80%, ${healthToBackgroundColor(score, 0.06)} 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, ${healthToBackgroundColor(score, 0.04)} 0%, transparent 50%)
            `;
        }

        // Switch tabs
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            renderHabits();
        }

        // Update tab counts
        function updateTabCounts() {
            document.getElementById('activeCount').textContent = getInProgressHabits().length;
            document.getElementById('backlogCount').textContent = getBacklogHabits().length;
            document.getElementById('deletedCount').textContent = getDeletedHabits().length;
        }

        // Get all non-deleted habits
        function getAllActiveHabits() {
            return habitsCache.filter(h => !h.deleted);
        }

        // Calculate and update overall metrics
        function updateOverallMetrics() {
            const activeHabits = getAllActiveHabits();

            let totalWeeklyCompleted = 0;
            let totalWeeklyPossible = 0;
            let totalAllTimeCompleted = 0;
            let totalAllTimePossible = 0;

            activeHabits.forEach(habit => {
                const weeklyStats = calculateWeeklyStats(habit.completions || {});
                const allTimeStats = calculateAllTimeStats(habit.completions || {}, habit.createdAt);

                totalWeeklyCompleted += weeklyStats.completed;
                totalWeeklyPossible += weeklyStats.total;
                totalAllTimeCompleted += allTimeStats.completed;
                totalAllTimePossible += allTimeStats.total;
            });

            document.getElementById('overallWeekly').textContent = `${totalWeeklyCompleted} / ${totalWeeklyPossible}`;
            document.getElementById('overallAllTime').textContent = `${totalAllTimeCompleted} / ${totalAllTimePossible}`;

            const allTimePercent = totalAllTimePossible > 0
                ? Math.round((totalAllTimeCompleted / totalAllTimePossible) * 100)
                : 0;
            document.getElementById('overallAllTimePercent').textContent = `${allTimePercent}%`;
        }

        // Render empty state for a tab
        function renderEmptyState(tab) {
            const states = {
                active: {
                    icon: 'üå±',
                    title: 'No active habits',
                    description: 'Start a habit to see it here'
                },
                backlog: {
                    icon: '‚ú®',
                    title: 'All habits started',
                    description: 'Add new habits to see them here before you begin'
                },
                deleted: {
                    icon: 'üóëÔ∏è',
                    title: 'No deleted habits',
                    description: 'Deleted habits will appear here for recovery'
                }
            };
            const state = states[tab] || states.active;
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">${state.icon}</div>
                    <h2>${state.title}</h2>
                    <p>${state.description}</p>
                </div>
            `;
        }

        // Render a single habit card
        function renderHabitCard(habit, days, applyHealthColor = false) {
            const originalIndex = habitsCache.indexOf(habit);
            const streak = calculateStreak(habit.completions || {});
            const weeklyStats = calculateWeeklyStats(habit.completions || {});
            const allTimeStats = calculateAllTimeStats(habit.completions || {}, habit.createdAt);
            const allTimePercent = allTimeStats.total > 0
                ? Math.round((allTimeStats.completed / allTimeStats.total) * 100)
                : 0;
            const isDeleted = habit.deleted;
            const showNoteTotals = hasNumericNotes(habit.completions || {});
            const weeklyNoteTotal = showNoteTotals ? calculateWeeklyNoteTotal(habit.completions || {}) : 0;
            const yearlyNoteTotal = showNoteTotals ? calculateYearlyNoteTotal(habit.completions || {}) : 0;

            // Calculate health color for in-progress habits
            let cardStyle = '';
            let borderColor = '';
            if (applyHealthColor && hasCompletions(habit) && !isDeleted) {
                const healthScore = calculateHealthScore(habit);
                const color = healthToColor(healthScore);
                borderColor = `border-left: 4px solid ${color};`;
            }

            return `
                <div class="habit-card ${isDeleted ? 'deleted' : ''}" style="${borderColor}">
                    <div class="habit-header">
                        <div>
                            <h2 class="habit-name">${escapeHtml(habit.name)}</h2>
                            <div class="habit-created">Created ${formatCreatedDate(habit.createdAt)}</div>
                        </div>
                        ${!isDeleted ? `<button class="habit-delete" onclick="deleteHabit(${originalIndex})" title="Delete habit">√ó</button>` : ''}
                    </div>
                    <div class="habit-stats">
                        <div class="stat">
                            <span class="stat-value success">${streak}</span>
                            <span class="stat-label">Current Streak</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${weeklyStats.completed} / 7</span>
                            <span class="stat-label">Past Week</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${allTimeStats.completed} / ${allTimeStats.total}</span>
                            <div class="stat-percent">${allTimePercent}%</div>
                            <span class="stat-label">All Time</span>
                        </div>
                    </div>
                    ${showNoteTotals ? `
                    <div class="note-totals">
                        <span class="note-total-item">${weeklyNoteTotal.toLocaleString()} ${escapeHtml(habit.name).toLowerCase()} this week</span>
                        <span class="note-total-divider">‚Ä¢</span>
                        <span class="note-total-item">${yearlyNoteTotal.toLocaleString()} this year</span>
                    </div>
                    ` : ''}
                    <div class="week-view">
                        ${days.map(day => {
                            const status = getCompletionStatus(habit.completions, day.date);
                            const note = getCompletionNote(habit.completions, day.date);
                            const isDisabled = day.isFuture || isDeleted;
                            const classes = [
                                'day-btn',
                                day.isToday && 'today',
                                isDisabled && 'future',
                                status === 'completed' && 'completed',
                                status === 'missed' && 'missed'
                            ].filter(Boolean).join(' ');
                            const icon = status === 'completed' ? '‚úì' : status === 'missed' ? '‚úó' : '';

                            return `
                                <div class="day">
                                    <span class="day-label">${day.dayName}</span>
                                    <span class="day-date">${day.dayNumber}</span>
                                    <button
                                        class="${classes}"
                                        onclick="${isDisabled ? '' : `toggleDay(${originalIndex}, '${day.date}')`}"
                                        ${isDisabled ? 'disabled' : ''}
                                    >${icon}</button>
                                    <input
                                        type="text"
                                        class="day-note"
                                        placeholder="..."
                                        value="${escapeHtml(note)}"
                                        onchange="updateNote(${originalIndex}, '${day.date}', this.value)"
                                        ${isDisabled ? 'disabled' : ''}
                                    >
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${isDeleted ? `
                        <div class="deleted-actions">
                            <button class="restore-btn" onclick="restoreHabit(${originalIndex})">Restore Habit</button>
                            <button class="delete-permanent-btn" onclick="permanentDeleteHabit(${originalIndex})">Delete Permanently</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Render analytics tab
        function renderAnalytics() {
            const inProgress = getInProgressHabits();
            const days = getLast7Days();

            if (inProgress.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <h2>No data yet</h2>
                        <p>Start tracking habits to see your analytics</p>
                    </div>
                `;
            }

            // Calculate daily completion rates for the past 4 weeks
            const weeklyData = [];
            for (let w = -3; w <= 0; w++) {
                const weekDays = getLast7Days(w);
                let completed = 0;
                let total = 0;
                weekDays.forEach(day => {
                    if (!day.isFuture) {
                        inProgress.forEach(habit => {
                            total++;
                            if (getCompletionStatus(habit.completions, day.date) === 'completed') {
                                completed++;
                            }
                        });
                    }
                });
                weeklyData.push({
                    label: w === 0 ? 'This week' : w === -1 ? 'Last week' : `${Math.abs(w) + 1} weeks ago`,
                    rate: total > 0 ? completed / total : 0,
                    completed,
                    total
                });
            }

            // Per-habit progress bars
            const habitBars = inProgress.map(habit => {
                const score = calculateHealthScore(habit);
                const color = healthToColor(score);
                const weeklyStats = calculateWeeklyStats(habit.completions || {});
                return `
                    <div class="progress-item">
                        <span class="progress-label" title="${escapeHtml(habit.name)}">${escapeHtml(habit.name)}</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${score * 100}%; background: ${color};"></div>
                        </div>
                        <span class="progress-value" style="color: ${color}">${weeklyStats.completed}/7</span>
                    </div>
                `;
            }).join('');

            // Weekly heatmap
            const heatmapDays = days.map(day => {
                let completed = 0;
                let total = 0;
                if (!day.isFuture) {
                    inProgress.forEach(habit => {
                        total++;
                        if (getCompletionStatus(habit.completions, day.date) === 'completed') {
                            completed++;
                        }
                    });
                }
                const rate = total > 0 ? completed / total : 0;
                const color = day.isFuture ? 'var(--bg-secondary)' : healthToColor(rate);
                const textColor = day.isFuture ? 'var(--text-muted)' : 'white';
                return `
                    <div class="heatmap-day" style="background: ${color}; color: ${textColor};">
                        <span class="heatmap-day-label">${day.dayName}</span>
                        <span>${day.isFuture ? '-' : Math.round(rate * 100) + '%'}</span>
                    </div>
                `;
            }).join('');

            // Trend chart (4 weeks)
            const trendBars = weeklyData.map(week => {
                const color = healthToColor(week.rate);
                const height = Math.max(week.rate * 100, 5);
                return `
                    <div class="trend-bar"
                         style="height: ${height}%; background: ${color};"
                         data-tooltip="${week.label}: ${Math.round(week.rate * 100)}%">
                    </div>
                `;
            }).join('');

            return `
                <div class="analytics-container">
                    <div class="analytics-card">
                        <h3>This Week by Day</h3>
                        <div class="weekly-heatmap">
                            ${heatmapDays}
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>Habit Performance (Last 7 Days)</h3>
                        <div class="habit-progress-bar">
                            ${habitBars}
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>4-Week Trend</h3>
                        <div class="trend-chart">
                            ${trendBars}
                        </div>
                        <div class="trend-labels">
                            <span>4 weeks ago</span>
                            <span>This week</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render habits
        function renderHabits() {
            const habitsList = document.getElementById('habitsList');
            const days = getLast7Days(weekOffset);

            updateTabCounts();
            updateOverallMetrics();
            updatePageColors();

            // Handle analytics tab separately
            if (currentTab === 'analytics') {
                habitsList.innerHTML = renderAnalytics();
                return;
            }

            // Get habits for current tab
            let html = '';

            if (currentTab === 'active') {
                const grouped = getActiveHabitsGrouped();
                const totalHabits = grouped.recentlyStarted.length + grouped.consistencyBuilt.length + grouped.established.length;

                if (totalHabits === 0) {
                    habitsList.innerHTML = renderEmptyState('active');
                    return;
                }

                // Render sections (top to bottom: Recently Started ‚Üí Consistency Built ‚Üí Established)
                if (grouped.recentlyStarted.length > 0) {
                    html += `<div class="section-header">Recently Started <span class="section-count">(${grouped.recentlyStarted.length})</span></div>`;
                    html += grouped.recentlyStarted.map(h => renderHabitCard(h, days, true)).join('');
                }

                if (grouped.consistencyBuilt.length > 0) {
                    html += `<div class="section-header">Consistency Built <span class="section-count">(${grouped.consistencyBuilt.length})</span></div>`;
                    html += grouped.consistencyBuilt.map(h => renderHabitCard(h, days, true)).join('');
                }

                if (grouped.established.length > 0) {
                    html += `<div class="section-header">Established <span class="section-count">(${grouped.established.length})</span></div>`;
                    html += grouped.established.map(h => renderHabitCard(h, days, true)).join('');
                }

            } else if (currentTab === 'backlog') {
                const habits = getBacklogHabits();
                if (habits.length === 0) {
                    habitsList.innerHTML = renderEmptyState('backlog');
                    return;
                }
                html = habits.map(h => renderHabitCard(h, days, false)).join('');

            } else if (currentTab === 'deleted') {
                const habits = getDeletedHabits();
                if (habits.length === 0) {
                    habitsList.innerHTML = renderEmptyState('deleted');
                    return;
                }
                html = habits.map(h => renderHabitCard(h, days, false)).join('');
            }

            habitsList.innerHTML = html;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add new habit
        async function addHabit(name) {
            const habits = [...habitsCache];
            habits.push({
                name: name.trim(),
                completions: {},
                createdAt: new Date().toISOString()
            });
            await saveHabits(habits);
            renderHabits();
        }

        // Soft delete habit (move to deleted)
        async function deleteHabit(index) {
            if (confirm('Are you sure you want to delete this habit? It will be moved to Deleted Habits.')) {
                const habits = [...habitsCache];
                habits[index].deleted = true;
                habits[index].deletedAt = new Date().toISOString();
                await saveHabits(habits);
                renderHabits();
            }
        }

        // Restore habit
        async function restoreHabit(index) {
            const habits = [...habitsCache];
            delete habits[index].deleted;
            delete habits[index].deletedAt;
            await saveHabits(habits);
            renderHabits();
        }

        // Permanently delete habit
        async function permanentDeleteHabit(index) {
            if (confirm('Are you sure you want to permanently delete this habit? This cannot be undone.')) {
                const habits = [...habitsCache];
                habits.splice(index, 1);
                await saveHabits(habits);
                renderHabits();
            }
        }

        // Toggle day status: empty -> completed -> missed -> empty
        async function toggleDay(habitIndex, dateStr) {
            const habits = [...habitsCache];
            const habit = habits[habitIndex];
            if (!habit.completions) {
                habit.completions = {};
            }

            const currentStatus = getCompletionStatus(habit.completions, dateStr);
            const currentNote = getCompletionNote(habit.completions, dateStr);

            let newStatus;
            if (!currentStatus) {
                newStatus = 'completed';
            } else if (currentStatus === 'completed') {
                newStatus = 'missed';
            } else {
                newStatus = null;
            }

            setCompletion(habit.completions, dateStr, newStatus, currentNote);

            // Update UI immediately for responsiveness
            habitsCache = habits;
            renderHabits();

            // Save in background
            await saveHabits(habits);
        }

        // Update note for a day
        async function updateNote(habitIndex, dateStr, note) {
            const habits = [...habitsCache];
            const habit = habits[habitIndex];
            if (!habit.completions) {
                habit.completions = {};
            }

            const currentStatus = getCompletionStatus(habit.completions, dateStr);
            setCompletion(habit.completions, dateStr, currentStatus, note.trim());

            habitsCache = habits;
            await saveHabits(habits);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Set current date
            document.getElementById('currentDate').textContent = formatDisplayDate(new Date());

            // Load and render habits
            await loadHabits();
            updateWeekNav();
            renderHabits();

            // Form submission
            document.getElementById('addHabitForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('habitInput');
                const name = input.value.trim();

                if (name) {
                    await addHabit(name);
                    input.value = '';
                }
            });
        });
    </script>
</body>
</html>
